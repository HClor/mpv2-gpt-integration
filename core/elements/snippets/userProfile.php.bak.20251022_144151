<?php
// TS USER PROFILE v1.4 (tabs: profile / password / stats / history)
if (!$modx instanceof modX) return 'MODX context required';

// 0) Auth
if (!$modx->user || !$modx->user->hasSessionContext('web')) {
    $authUrl = $modx->makeUrl(24, '', '', 'abs');
    return '<div class="alert alert-warning">Войдите, чтобы просмотреть профиль.<br><a class="btn btn-primary mt-2" href="'.htmlspecialchars($authUrl,ENT_QUOTES,'UTF-8').'">Войти</a></div>';
}

// 1) Init
$prefix = $modx->getOption('table_prefix');
$userId = (int)$modx->user->get('id');
$errors = [];
$success = '';
if (session_status() === PHP_SESSION_NONE) { session_start(); }
if (empty($_SESSION['csrf'])) { $_SESSION['csrf'] = bin2hex(random_bytes(16)); }
$csrf = $_SESSION['csrf'];

$h = function($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); };
$getp = function($key){ return trim((string)($_POST[$key] ?? '')); };

// 2) Update profile
if (!empty($_POST) && isset($_POST['update_profile'])) {
    if (!hash_equals($csrf, $_POST['csrf'] ?? '')) {
        $errors[] = 'Неверный CSRF-токен, обновите страницу.';
    } else {
        $fullname = $getp('fullname');
        $email    = $getp('email');

        if ($email === '') {
            $errors[] = 'Email обязателен';
        } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Неверный формат email';
        } else {
            $sql = "SELECT COUNT(*) FROM `{$prefix}user_attributes` WHERE email = ? AND internalKey != ?";
            $stmt = $modx->prepare($sql);
            $stmt->execute([$email, $userId]);
            if ((int)$stmt->fetchColumn() > 0) {
                $errors[] = 'Email уже используется другим пользователем';
            } else {
                $profile = $modx->user->getOne('Profile');
                if ($profile) {
                    $profile->set('email', $email);
                    $profile->set('fullname', $fullname);
                    if ($profile->save()) $success = 'Профиль обновлён';
                    else $errors[] = 'Не удалось сохранить профиль';
                } else {
                    $errors[] = 'Профиль пользователя не найден';
                }
            }
        }
    }
}

// 3) Change password
if (!empty($_POST) && isset($_POST['change_password'])) {
    if (!hash_equals($csrf, $_POST['csrf'] ?? '')) {
        $errors[] = 'Неверный CSRF-токен, обновите страницу.';
    } else {
        $pass_old = $getp('password_old');
        $pass_new = $getp('password_new');
        $pass_new2= $getp('password_new2');

        if ($pass_new === '' || $pass_new2 === '') {
            $errors[] = 'Укажите новый пароль (два раза)';
        } elseif ($pass_new !== $pass_new2) {
            $errors[] = 'Новый пароль и подтверждение не совпадают';
        } else {
            $sql = "SELECT password FROM `{$prefix}users` WHERE id = ?";
            $stmt = $modx->prepare($sql); $stmt->execute([$userId]);
            $hash = (string)$stmt->fetchColumn();
            if ($hash === '' || !password_verify($pass_old, $hash)) {
                $errors[] = 'Старый пароль неверен';
            } else {
                $newHash = password_hash($pass_new, PASSWORD_DEFAULT);
                $sql = "UPDATE `{$prefix}users` SET password=? WHERE id=?";
                $st2 = $modx->prepare($sql);
                if ($st2->execute([$newHash, $userId])) $success = 'Пароль обновлён';
                else $errors[] = 'Не удалось обновить пароль';
            }
        }
    }
}

// 4) Profile data
$profile = $modx->user->getOne('Profile');
$fullname = $profile ? $profile->get('fullname') : '';
$email    = $profile ? $profile->get('email') : '';

// 5) Stats (available tests / attempts / avg / pass-fail)
$T_sessions = $prefix.'test_sessions';
$T_tests    = $prefix.'test_tests';
$S          = $prefix.'site_content';

$st = $modx->prepare("SELECT COUNT(*) FROM `{$T_sessions}` WHERE user_id = ?");
$st->execute([$userId]); $attemptsTotal = (int)$st->fetchColumn();

$st = $modx->prepare("SELECT AVG(score) FROM `{$T_sessions}` WHERE user_id = ?");
$st->execute([$userId]); $avgScore = (float)$st->fetchColumn(); $avgScore = $avgScore ? round($avgScore,1) : 0;

$st = $modx->prepare("SELECT SUM(pass=1), SUM(pass=0) FROM `{$T_sessions}` WHERE user_id = ?");
$st->execute([$userId]); [$passed,$failed] = array_map('intval', $st->fetch(PDO::FETCH_NUM) ?: [0,0]);

$st = $modx->prepare("SELECT COUNT(*) 
  FROM `{$T_tests}` t 
  JOIN `{$S}` sc ON sc.alias = CONCAT('test-', t.id) AND sc.published=1 AND sc.deleted=0");
$st->execute(); $testsAvailable=(int)$st->fetchColumn();

$sql = "SELECT s.id, s.test_id, s.score, s.pass, s.created_at, 
               t.title, sc.id AS rid
        FROM `{$T_sessions}` s
        JOIN `{$T_tests}` t ON t.id=s.test_id
        LEFT JOIN `{$S}` sc ON sc.alias = CONCAT('test-', s.test_id) AND sc.published=1 AND sc.deleted=0
        WHERE s.user_id = ?
        ORDER BY s.created_at DESC
        LIMIT 10";
$st=$modx->prepare($sql); $st->execute([$userId]);
$lastAttempts = $st->fetchAll(PDO::FETCH_ASSOC) ?: [];

// 6) UI (tabs)
$out = [];
if ($success) $out[] = '<div class="alert alert-success">'.$h($success).'</div>';
if ($errors) {
  $out[] = '<div class="alert alert-danger"><ul class="mb-0">';
  foreach ($errors as $e) $out[] = '<li>'.$h($e).'</li>';
  $out[] = '</ul></div>';
}

$out[] = '
<ul class="nav nav-tabs" id="profileTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-profile" data-bs-toggle="tab" data-bs-target="#pane-profile" type="button" role="tab">Профиль</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-password" data-bs-toggle="tab" data-bs-target="#pane-password" type="button" role="tab">Смена пароля</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-stats" data-bs-toggle="tab" data-bs-target="#pane-stats" type="button" role="tab">Статистика</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-history" data-bs-toggle="tab" data-bs-target="#pane-history" type="button" role="tab">История</button>
  </li>
</ul>
<div class="tab-content pt-3" id="profileTabsContent">
  <div class="tab-pane fade show active" id="pane-profile" role="tabpanel" aria-labelledby="tab-profile">
    <div class="card"><div class="card-body">
      <h5 class="card-title">Профиль</h5>
      <form method="post" autocomplete="off">
        <input type="hidden" name="csrf" value="'.$h($csrf).'">
        <div class="mb-3">
          <label class="form-label">Имя</label>
          <input class="form-control" name="fullname" value="'.$h($fullname).'">
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input class="form-control" name="email" value="'.$h($email).'" required>
        </div>
        <button class="btn btn-primary" type="submit" name="update_profile" value="1">Сохранить</button>
      </form>
    </div></div>
  </div>

  <div class="tab-pane fade" id="pane-password" role="tabpanel" aria-labelledby="tab-password">
    <div class="card"><div class="card-body">
      <h5 class="card-title">Смена пароля</h5>
      <form method="post" autocomplete="off">
        <input type="hidden" name="csrf" value="'.$h($csrf).'">
        <div class="mb-3">
          <label class="form-label">Текущий пароль</label>
          <input type="password" class="form-control" name="password_old" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Новый пароль</label>
          <input type="password" class="form-control" name="password_new" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Повторите новый пароль</label>
          <input type="password" class="form-control" name="password_new2" required>
        </div>
        <button class="btn btn-warning" type="submit" name="change_password" value="1">Обновить пароль</button>
      </form>
    </div></div>
  </div>

  <div class="tab-pane fade" id="pane-stats" role="tabpanel" aria-labelledby="tab-stats">
    <div class="card"><div class="card-body">
      <h5 class="card-title">Моя статистика</h5>
      <div class="row text-center">
        <div class="col-6 col-md-3"><div class="fw-bold fs-4">'.$h($testsAvailable).'</div><div class="text-muted">Доступно тестов</div></div>
        <div class="col-6 col-md-3"><div class="fw-bold fs-4">'.$h($attemptsTotal).'</div><div class="text-muted">Всего попыток</div></div>
        <div class="col-6 col-md-3"><div class="fw-bold fs-4">'.$h($avgScore).'%</div><div class="text-muted">Средний балл</div></div>
        <div class="col-6 col-md-3"><div class="fw-bold fs-4">'.$h($passed).'/'.$h($failed).'</div><div class="text-muted">Пройдено / Нет</div></div>
      </div>
    </div></div>
  </div>

  <div class="tab-pane fade" id="pane-history" role="tabpanel" aria-labelledby="tab-history">
    <div class="card"><div class="card-body">
      <h5 class="card-title">Последние попытки</h5>';
if (!$lastAttempts) {
  $out[] .= '<div class="text-muted">Пока нет попыток</div>';
} else {
  $out[] .= '<div class="table-responsive"><table class="table table-sm align-middle mb-0">
    <thead><tr><th>Тест</th><th class="text-end">Балл</th><th class="text-center">Статус</th><th class="text-end">Дата</th></tr></thead><tbody>';
  foreach($lastAttempts as $a){
    $title = $h($a['title'] ?? ('Тест #'.$a['test_id']));
    $score = (int)$a['score'].'%';
    $status= ((int)$a['pass']===1) ? '<span class="badge bg-success">пройден</span>' : '<span class="badge bg-secondary">нет</span>';
    $date  = $h($a['created_at'] ?? '');
    $link  = !empty($a['rid']) ? $h($modx->makeUrl((int)$a['rid'],'','', 'abs')) : '#';
    $cellTitle = $link!=='#' ? '<a href="'.$link.'">'.$title.'</a>' : $title;
    $out[] .= '<tr><td>'.$cellTitle.'</td><td class="text-end">'.$score.'</td><td class="text-center">'.$status.'</td><td class="text-end">'.$date.'</td></tr>';
  }
  $out[] .= '</tbody></table></div>';
}
$out[] .= '</div></div>
  </div>
</div>';

return implode('', $out);