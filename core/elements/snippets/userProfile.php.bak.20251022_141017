<?php
// TS USER PROFILE v1.3 (auth + CSRF + prefix + prepared + sanitize)
if (!$modx instanceof modX) return 'MODX context required';

// 0) Авторизация
if (!$modx->user || !$modx->user->hasSessionContext('web')) {
    $authUrl = $modx->makeUrl(24, '', '', 'abs');
    return '<div class="alert alert-warning">Войдите, чтобы просмотреть профиль.<br><a class="btn btn-primary mt-2" href="'.htmlspecialchars($authUrl,ENT_QUOTES,'UTF-8').'">Войти</a></div>';
}

// 1) Инициализация
$prefix = $modx->getOption('table_prefix');
$userId = (int)$modx->user->get('id');
$errors = [];
$success = '';
if (session_status() === PHP_SESSION_NONE) { session_start(); }
if (empty($_SESSION['csrf'])) { $_SESSION['csrf'] = bin2hex(random_bytes(16)); }
$csrf = $_SESSION['csrf'];

// 2) Безопасные хелперы
$h = function($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); };
$getp = function($key){ return trim((string)($_POST[$key] ?? '')); };

// 3) Обновление профиля
if (!empty($_POST) && isset($_POST['update_profile'])) {
    // CSRF
    if (!hash_equals($csrf, $_POST['csrf'] ?? '')) {
        $errors[] = 'Неверный CSRF-токен, обновите страницу.';
    } else {
        $fullname = $getp('fullname');
        $email    = $getp('email');

        if ($email === '') {
            $errors[] = 'Email обязателен';
        } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Неверный формат email';
        } else {
            // Email уникальность
            $sql = "SELECT COUNT(*) FROM `{$prefix}user_attributes` WHERE email = ? AND internalKey != ?";
            $stmt = $modx->prepare($sql);
            $stmt->execute([$email, $userId]);
            if ((int)$stmt->fetchColumn() > 0) {
                $errors[] = 'Email уже используется другим пользователем';
            } else {
                $profile = $modx->user->getOne('Profile');
                if ($profile) {
                    $profile->set('email', $email);
                    $profile->set('fullname', $fullname);
                    if ($profile->save()) {
                        $success = 'Профиль обновлён';
                    } else {
                        $errors[] = 'Не удалось сохранить профиль';
                    }
                } else {
                    $errors[] = 'Профиль пользователя не найден';
                }
            }
        }
    }
}

// 4) Смена пароля
if (!empty($_POST) && isset($_POST['change_password'])) {
    if (!hash_equals($csrf, $_POST['csrf'] ?? '')) {
        $errors[] = 'Неверный CSRF-токен, обновите страницу.';
    } else {
        $pass_old = $getp('password_old');
        $pass_new = $getp('password_new');
        $pass_new2= $getp('password_new2');

        if ($pass_new === '' || $pass_new2 === '') {
            $errors[] = 'Укажите новый пароль (два раза)';
        } elseif ($pass_new !== $pass_new2) {
            $errors[] = 'Новый пароль и подтверждение не совпадают';
        } else {
            // Проверяем старый
            $sql = "SELECT password FROM `{$prefix}users` WHERE id = ?";
            $stmt = $modx->prepare($sql); $stmt->execute([$userId]);
            $hash = (string)$stmt->fetchColumn();
            if ($hash === '' || !password_verify($pass_old, $hash)) {
                $errors[] = 'Старый пароль неверен';
            } else {
                $newHash = password_hash($pass_new, PASSWORD_DEFAULT);
                $sql = "UPDATE `{$prefix}users` SET password=? WHERE id=?";
                $st2 = $modx->prepare($sql); 
                if ($st2->execute([$newHash, $userId])) {
                    $success = 'Пароль обновлён';
                } else {
                    $errors[] = 'Не удалось обновить пароль';
                }
            }
        }
    }
}

// 5) Данные профиля
$profile = $modx->user->getOne('Profile');
$fullname = $profile ? $profile->get('fullname') : '';
$email    = $profile ? $profile->get('email') : '';

// 6) Вывод
$out = [];
if ($success) $out[] = '<div class="alert alert-success">'.$h($success).'</div>';
if ($errors) {
    $out[] = '<div class="alert alert-danger"><ul class="mb-0">';
    foreach ($errors as $e) $out[] = '<li>'.$h($e).'</li>';
    $out[] = '</ul></div>';
}

// Форма профиля
$out[] = '<div class="card mb-3"><div class="card-body">';
$out[] = '<h5 class="card-title">Профиль</h5>';
$out[] = '<form method="post" autocomplete="off">';
$out[] = '<input type="hidden" name="csrf" value="'.$h($csrf).'">';
$out[] = '<div class="mb-3"><label class="form-label">Имя</label><input class="form-control" name="fullname" value="'.$h($fullname).'"></div>';
$out[] = '<div class="mb-3"><label class="form-label">Email</label><input class="form-control" name="email" value="'.$h($email).'" required></div>';
$out[] = '<button class="btn btn-primary" type="submit" name="update_profile" value="1">Сохранить</button>';
$out[] = '</form></div></div>';

// Форма смены пароля
$out[] = '<div class="card"><div class="card-body">';
$out[] = '<h5 class="card-title">Смена пароля</h5>';
$out[] = '<form method="post" autocomplete="off">';
$out[] = '<input type="hidden" name="csrf" value="'.$h($csrf).'">';
$out[] = '<div class="mb-3"><label class="form-label">Текущий пароль</label><input type="password" class="form-control" name="password_old" required></div>';
$out[] = '<div class="mb-3"><label class="form-label">Новый пароль</label><input type="password" class="form-control" name="password_new" required></div>';
$out[] = '<div class="mb-3"><label class="form-label">Повторите новый пароль</label><input type="password" class="form-control" name="password_new2" required></div>';
$out[] = '<button class="btn btn-warning" type="submit" name="change_password" value="1">Обновить пароль</button>';
$out[] = '</form></div></div>';

return implode('', $out);