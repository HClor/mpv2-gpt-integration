<?php
/* TS CATEGORIES AND TESTS v2.3 RESOURCE-BASED COUNTS +*/

if (!$modx instanceof modX) return 'MODX context required';

$prefix = $modx->getOption('table_prefix');
$Tcats  = $prefix.'test_categories';
$Ttests = $prefix.'test_tests';
$S      = $prefix.'site_content';

$categoryId = (int)($modx->stripTags($_GET['category'] ?? 0));

$html = [];
$html[] = '<div class="row">';

/* ЛЕВАЯ КОЛОНКА — категории с корректным счётчиком видимых тестов */
$html[] = '<div class="col-md-3">';
$html[] = '<div class="card sticky-top" style="top: 20px;">';
$html[] = '<div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Категории</h5></div>';
$html[] = '<div class="list-group list-group-flush">';

/* считаем только тесты, у которых существует опубликованный ресурс test-{id} */
$sql = "
  SELECT
    c.id,
    c.name,
    SUM(
      CASE WHEN EXISTS (
        SELECT 1
        FROM `{$S}` sc
        WHERE sc.alias = CONCAT('test-', t.id)
          AND sc.published = 1
          AND sc.deleted   = 0
      ) THEN 1 ELSE 0 END
    ) AS test_count
  FROM `{$Tcats}` c
  LEFT JOIN `{$Ttests}` t
    ON t.category_id = c.id
   AND t.is_active   = 1
  GROUP BY c.id, c.name
  ORDER BY c.sort_order
";
$stmt = $modx->prepare($sql);
$stmt->execute();
$categories = $stmt->fetchAll(PDO::FETCH_ASSOC);

foreach ($categories as $cat) {
    $isActive    = ($cat['id'] == $categoryId) ? 'active' : '';
    $categoryUrl = htmlspecialchars($modx->makeUrl($modx->resource->id).'?category='.$cat['id'], ENT_QUOTES, 'UTF-8');

    $html[] = '<a href="'.$categoryUrl.'" class="list-group-item list-group-item-action '.$isActive.'">';
    $html[] = '<div class="d-flex justify-content-between align-items-center">';
    $html[] = '<span>'.htmlspecialchars($cat['name'], ENT_QUOTES, 'UTF-8').'</span>';
    $html[] = '<span class="badge bg-secondary rounded-pill">'.(int)$cat['test_count'].'</span>';
    $html[] = '</div></a>';
}

$rights = $modx->runSnippet('getUserRights');
if (!empty($rights['canCreate'])) {
    $addUrl = htmlspecialchars($modx->makeUrl($modx->getOption('lms.add_test_page', null, 0)), ENT_QUOTES, 'UTF-8');
    $html[] = '<div class="card-footer"><a href="'.$addUrl.'" class="btn btn-success btn-sm w-100">+ Добавить тест</a></div>';
}
$html[] = '</div></div>'; // list-group, card
$html[] = '</div>'; // col-3

/* ПРАВАЯ КОЛОНКА — список тестов категории (только с существующим ресурсом) */
$html[] = '<div class="col-md-9">';

if (!$categoryId) {
    $html[] = '<div class="card"><div class="card-body text-center py-5">';
    $html[] = '<h3>Выберите категорию</h3>';
    $html[] = '<p class="text-muted">Выберите категорию слева, чтобы увидеть список тестов</p>';
    $html[] = '</div></div>';
} else {
    // Категория
    $stmt = $modx->prepare("SELECT name, description FROM `{$Tcats}` WHERE id = ?");
    $stmt->execute([$categoryId]);
    $category = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$category) {
        $html[] = '<div class="alert alert-danger">Категория не найдена</div>';
    } else {
        $html[] = '<div class="mb-4">';
        $html[] = '<h2>'.htmlspecialchars($category['name'], ENT_QUOTES, 'UTF-8').'</h2>';
        $html[] = '<p class="text-muted">'.htmlspecialchars($category['description'], ENT_QUOTES, 'UTF-8').'</p>';
        $html[] = '</div>';

        // Тесты категории, у которых есть опубликованный ресурс test-{id}
        $sql = "
          SELECT t.id, t.title, t.description, t.mode, t.questions_per_session, t.pass_score, sc.id AS resource_id
          FROM `{$Ttests}` t
          JOIN `{$S}` sc
            ON sc.alias = CONCAT('test-', t.id)
           AND sc.published = 1
           AND sc.deleted   = 0
          WHERE t.category_id = ? AND t.is_active = 1
          ORDER BY t.created_at DESC
        ";
        $stmt = $modx->prepare($sql);
        $stmt->execute([$categoryId]);
        $tests = $stmt->fetchAll(PDO::FETCH_ASSOC);

        if (!$tests) {
            $html[] = '<div class="alert alert-info"><h5>В этой категории пока нет тестов</h5>';
            if (!empty($rights['canCreate'])) {
                $addUrl = htmlspecialchars($modx->makeUrl($modx->getOption('lms.add_test_page', null, 0)), ENT_QUOTES, 'UTF-8');
                $html[] = '<a href="'.$addUrl.'" class="btn btn-primary mt-2">Создать первый тест</a>';
            }
            $html[] = '</div>';
        } else {
            foreach ($tests as $test) {
                // Вопросы
                $st = $modx->prepare("SELECT COUNT(*) FROM `{$prefix}test_questions` WHERE test_id = ?");
                $st->execute([$test['id']]);
                $questionCount = (int)$st->fetchColumn();

                $testUrl = htmlspecialchars($modx->makeUrl((int)$test['resource_id']), ENT_QUOTES, 'UTF-8');

                $html[] = '<div class="card mb-3"><div class="card-body"><div class="row align-items-center">';
                $html[] = '<div class="col-md-8">';
                $html[] = '<h5 class="card-title mb-2">'.htmlspecialchars($test['title'], ENT_QUOTES, 'UTF-8').'</h5>';
                $html[] = '<p class="card-text text-muted mb-2">'.htmlspecialchars($test['description'], ENT_QUOTES, 'UTF-8').'</p>';
                $html[] = '<div class="small text-muted">';
                $html[] = '<span class="me-3">Вопросов: '.$questionCount.'</span>';
                $html[] = '<span class="me-3">За попытку: '.(int)$test['questions_per_session'].'</span>';
                $html[] = '<span>Проходной балл: '.(int)$test['pass_score'].'%</span>';
                $html[] = '</div></div>';
                $html[] = '<div class="col-md-4 text-md-end">';
                $html[] = '<a href="'.$testUrl.'" class="btn btn-primary">Начать тест</a>';
                $html[] = '</div></div></div></div>';
            }
        }
    }
}

$html[] = '</div>'; // col-9
$html[] = '</div>'; // row

return implode('', $html);