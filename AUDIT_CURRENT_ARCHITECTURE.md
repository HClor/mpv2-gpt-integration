# 🏗️ ТЕКУЩАЯ АРХИТЕКТУРА СИСТЕМЫ

**Дата:** 2025-11-13
**Проект:** MPV2 Test System (MODX REVO)
**Версия:** 1.0 (текущая)

---

## 📊 ОБЗОР СИСТЕМЫ

**MPV2 Test System** - система онлайн тестирования и обучения на базе MODX Revolution.

### Ключевые возможности:
- ✅ Создание и прохождение тестов (Training/Exam режимы)
- ✅ Управление вопросами и ответами
- ✅ Импорт вопросов из CSV/Excel
- ✅ Персональные области знаний
- ✅ Система прав доступа (public/private/unlisted/draft)
- ✅ Лидерборды и статистика
- ✅ Избранные тесты

---

## 🗂️ СТРУКТУРА ПРОЕКТА

```
/home/user/mpv2-gpt-integration/
│
├── core/                           # Серверная часть
│   └── elements/
│       ├── snippets/              # 31 PHP сниппет (5668 строк)
│       ├── chunks/                # HTML чанки для рендеринга
│       └── templates/             # Шаблоны страниц
│
├── assets/                        # Фронтенд и публичные файлы
│   └── components/
│       └── testsystem/
│           ├── js/                # JavaScript (~4798 строк)
│           │   ├── tsrunner.js    # Главный файл тестирования
│           │   ├── mytests.js
│           │   └── knowledge-areas.js
│           ├── css/               # Стили
│           ├── ajax/              # AJAX обработчики
│           │   ├── testsystem.php # Главный API (~3000+ строк)
│           │   └── upload-image.php
│           ├── images/            # Загруженные изображения
│           └── templates/
│
├── composer.json                  # Зависимости (phpspreadsheet)
├── config.core.php               # Конфигурация MODX
└── index.php                     # Точка входа

**Общий объем кода:** ~13 500+ строк PHP + JS
```

---

## 🎯 АРХИТЕКТУРНЫЙ ПАТТЕРН

### Текущая архитектура: **МОНОЛИТНАЯ**

```
┌─────────────────────────────────────────────────────┐
│              PRESENTATION LAYER                     │
│  ┌──────────────┐  ┌──────────────┐                │
│  │   MODX       │  │  JavaScript  │                │
│  │  Templates   │  │   Frontend   │                │
│  └──────┬───────┘  └──────┬───────┘                │
└─────────┼──────────────────┼──────────────────────────┘
          │                  │
          ▼                  ▼
┌─────────────────────────────────────────────────────┐
│              BUSINESS LOGIC LAYER                   │
│  ┌──────────────────────────────────────────┐      │
│  │         31 SNIPPETS (монолиты)           │      │
│  │  - testRunner.php (733 строки)           │      │
│  │  - csvImportForm.php (482 строки)        │      │
│  │  - myFavorites.php (448 строк)           │      │
│  │  - ... и другие                          │      │
│  │                                           │      │
│  │  ❌ Логика смешана с представлением       │      │
│  │  ❌ Дублирование кода (30-40%)            │      │
│  │  ❌ Нет разделения ответственности        │      │
│  └──────────────────────────────────────────┘      │
│                                                     │
│  ┌──────────────────────────────────────────┐      │
│  │     AJAX API (testsystem.php)            │      │
│  │  - 30+ actions в одном файле             │      │
│  │  - 3000+ строк                           │      │
│  │  ❌ Монолит без разделения               │      │
│  └──────────────────────────────────────────┘      │
└─────────────────────┼───────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│               DATA ACCESS LAYER                     │
│  ┌──────────────────────────────────────────┐      │
│  │    Прямые SQL запросы (116+)             │      │
│  │  - Разбросаны по всем файлам             │      │
│  │  - Нет единой точки доступа              │      │
│  │  ❌ Нет Repository Pattern                │      │
│  │  ❌ Нет ORM                               │      │
│  └──────────────────────────────────────────┘      │
└─────────────────────┼───────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│                   DATABASE                          │
│  - modx_test_tests                                  │
│  - modx_test_questions                              │
│  - modx_test_answers                                │
│  - modx_test_sessions                               │
│  - modx_test_user_answers                           │
│  - modx_test_permissions                            │
│  - modx_test_favorites                              │
│  - modx_test_knowledge_areas                        │
│  - modx_test_user_stats                             │
│  - modx_test_category_stats                         │
│  - modx_test_categories                             │
│  - modx_test_notifications                          │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 ТЕХНОЛОГИЧЕСКИЙ СТЕК

### Backend:
- **PHP:** 7.4+ (требуется проверка версии)
- **MODX Revolution:** 2.x
- **Библиотеки:**
  - PHPSpreadsheet 5.2 (импорт Excel)
  - PDO (работа с БД)

### Frontend:
- **JavaScript:** Vanilla JS (ES6+)
- **CSS:** Bootstrap 5
- **Библиотеки:**
  - Quill.js 1.3.6 (Rich Text Editor)
  - Bootstrap Icons

### Database:
- **MySQL/MariaDB:** 5.7+
- **Префикс таблиц:** `modx_`

---

## 📦 ОСНОВНЫЕ МОДУЛИ

### 1. **Test Core** (Ядро тестирования)

**Компоненты:**
- `testRunner.php` - отображение и прохождение тестов
- `tsrunner.js` - фронтенд логика
- `testsystem.php` - AJAX API

**Потоки данных:**

#### Прохождение теста:
```
Пользователь → testRunner.php → tsrunner.js
                                      ↓
                              startTest() AJAX
                                      ↓
                          testsystem.php (action: startTest)
                                      ↓
                        Создание session в БД
                                      ↓
                          getNextQuestion() AJAX
                                      ↓
                    Выборка случайного вопроса из БД
                                      ↓
                          Отображение вопроса
                                      ↓
                         submitAnswer() AJAX
                                      ↓
                  Валидация ответа + сохранение в БД
                                      ↓
                   Обновление статистики (test_user_stats)
```

### 2. **Content Management** (Управление контентом)

**Компоненты:**
- `addTestForm.php` - создание тестов
- `csvImportForm.php` - импорт вопросов
- `manageCategories.php` - управление категориями

**Потоки данных:**

#### Создание теста:
```
Форма addTestForm
        ↓
Создание записи в test_tests
        ↓
Создание MODX ресурса (site_content)
        ↓
Редирект на csvImportForm
        ↓
Импорт вопросов из CSV/Excel
        ↓
Парсинг через PHPSpreadsheet
        ↓
Сохранение в test_questions + test_answers
```

### 3. **User Management** (Управление пользователями)

**Компоненты:**
- `authHandler.php` - вход/регистрация
- `userProfile.php` - профиль
- `manageUsers.php` - админка пользователей

**Роли:**
- **LMS Admins** - полный доступ
- **LMS Experts** - создание и управление тестами
- **Users** - прохождение тестов

### 4. **Analytics** (Аналитика)

**Компоненты:**
- `leaderboard.php` - общий лидерборд
- `leaderboardCategories.php` - по категориям
- `getSystemStats.php` - статистика системы
- `getUserStats.php` - статистика пользователя

**Таблицы:**
- `test_user_stats` - агрегированная статистика
- `test_category_stats` - статистика по категориям

---

## 🔄 КРИТИЧЕСКИЕ ЗАВИСИМОСТИ

### 1. testRunner.php ↔ testsystem.php
**Проблема:** Циклическая зависимость

testRunner генерирует HTML → включает tsrunner.js → вызывает testsystem.php → возвращает данные

### 2. csvImportForm.php → PHPSpreadsheet
**Зависимость:** Composer пакет
**Риск:** Средний (стабильная библиотека)

### 3. Все сниппеты → MODX API
**Зависимость:** Критическая
**Риск:** Низкий (используется стандартное API)

---

## ⚠️ АРХИТЕКТУРНЫЕ ПРОБЛЕМЫ

### 1. **Нарушение SOLID принципов**

#### Single Responsibility Principle (SRP):
❌ `testRunner.php` отвечает за:
- Проверку прав
- Загрузку данных
- Генерацию HTML
- Логику областей знаний

#### Open/Closed Principle (OCP):
❌ Добавление новой роли требует изменения 17+ файлов

#### Dependency Inversion Principle (DIP):
❌ Сниппеты напрямую зависят от БД (нет абстракции)

### 2. **Отсутствие паттернов проектирования**

❌ **Нет MVC/MVP/MVVM**
❌ **Нет Repository Pattern**
❌ **Нет Service Layer**
❌ **Нет Dependency Injection**
❌ **Нет Strategy Pattern** (для разных режимов тестов)

### 3. **Технический долг**

| Категория | Объем | Приоритет |
|-----------|-------|-----------|
| Дублирование кода | ~1800 строк | 🔴 HIGH |
| Монолитные файлы | 3+ файла > 400 строк | 🔴 HIGH |
| Отсутствие тестов | 100% | 🟡 MEDIUM |
| Хардкоженные значения | 20+ мест | 🟡 MEDIUM |
| Отсутствие документации | 90% | 🟢 LOW |

---

## 📈 МЕТРИКИ КОДА

### Сложность:

| Файл | Строк | Цикломатическая сложность (оценка) | Maintainability |
|------|-------|-----------------------------------|-----------------|
| testsystem.php | 3000+ | ОЧЕНЬ ВЫСОКАЯ | 🔴 КРИТИЧНО |
| testRunner.php | 733 | ВЫСОКАЯ | 🟡 СРЕДНЕ |
| csvImportForm.php | 482 | ВЫСОКАЯ | 🟡 СРЕДНЕ |
| tsrunner.js | ~2500 | ВЫСОКАЯ | 🟡 СРЕДНЕ |

### Связанность (Coupling):
- **Высокая связанность** между сниппетами и БД
- **Высокая связанность** между JS и AJAX API
- **Низкая связность** (Cohesion) - функции размазаны

---

## 🎯 ЦЕЛЕВАЯ АРХИТЕКТУРА (для рефакторинга)

### Предлагаемый подход: **Layered Architecture + Service Layer**

```
┌────────────────────────────────────────────────┐
│         PRESENTATION LAYER                     │
│  - Snippets (тонкие контроллеры)               │
│  - Templates + Chunks                          │
│  - JavaScript Frontend                         │
└────────────────┬───────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────┐
│         APPLICATION LAYER                      │
│  - Controllers (API endpoints)                 │
│  - Request/Response handlers                   │
│  - Validation                                  │
└────────────────┬───────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────┐
│         SERVICE LAYER (NEW!)                   │
│  ┌──────────────────────────────────┐          │
│  │ - TestService                    │          │
│  │ - QuestionService                │          │
│  │ - UserService                    │          │
│  │ - AccessService                  │          │
│  │ - StatisticsService              │          │
│  └──────────────────────────────────┘          │
└────────────────┬───────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────┐
│         DATA ACCESS LAYER (NEW!)               │
│  ┌──────────────────────────────────┐          │
│  │ Repositories:                    │          │
│  │ - TestRepository                 │          │
│  │ - QuestionRepository             │          │
│  │ - UserRepository                 │          │
│  │ - SessionRepository              │          │
│  └──────────────────────────────────┘          │
└────────────────┬───────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────┐
│         DATABASE                               │
└────────────────────────────────────────────────┘
```

---

## 💡 КЛЮЧЕВЫЕ ВЫВОДЫ

### ✅ Что работает хорошо:
1. ✅ Функциональность полная и рабочая
2. ✅ Используются prepared statements (защита от SQL injection)
3. ✅ Модульная структура (31 сниппет легко найти)
4. ✅ Богатый функционал (тесты, области знаний, статистика)

### ❌ Что нужно улучшить:
1. ❌ Архитектура (монолит → слои)
2. ❌ Дублирование кода (32%)
3. ❌ Безопасность (CSRF, валидация)
4. ❌ Тестирование (нет unit/integration тестов)
5. ❌ Документация (нет API docs)

### 🎯 Приоритеты:
1. **Краткосрочные** (1-2 недели): Безопасность + базовый рефакторинг
2. **Среднесрочные** (1-2 месяца): Service Layer + Repositories
3. **Долгосрочные** (3-6 месяцев): Полный рефакторинг архитектуры

---

**Файл создан автоматически в рамках Этапа 1 аудита кода.**
